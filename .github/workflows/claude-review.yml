name: Claude Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude-pr-body:
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: anthropics/claude-code-action@v1
        id: claude-review
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: "변경사항을 프론트엔드 전문가 관점으로 코드 리뷰해주세요."
          claude_args: "--max-turns 10 --allowedTools 'View' 'GlobTool' 'GrepTool'"
      - name: PR에 리뷰 결과 코멘트 작성
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const executionFile = '${{ steps.claude-review.outputs.execution_file }}';
            const fullOutput = fs.readFileSync(executionFile, 'utf8');

            let reviewResult;
            try {
              // JSON 형식 파싱 시도
              const jsonData = JSON.parse(fullOutput);
              const resultObj = jsonData.find(item => item.type === 'result');
              reviewResult = resultObj?.result || fullOutput;
            } catch {
              // JSON이 아니면 정규식으로 추출
              const finalResultMatch = fullOutput.match(/## ✅ Final Result\n\n([\s\S]*?)(?:\*\*Cost:|\n---\n|$)/);
              reviewResult = finalResultMatch ? finalResultMatch[1].trim() : fullOutput;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 🤖 Claude Frontend Review\n\n> 💡 참고: AI 리뷰는 보조 도구입니다. 최종 판단은 팀원이 해주세요.\n\n<details>\n<summary>📋 리뷰 결과 보기 (클릭)</summary>\n\n${reviewResult}\n\n</details>`
            });

  claude-comment:
    if: |
      (github.event_name == 'pull_request_review_comment' ||
       (github.event_name == 'issue_comment' && github.event.issue.pull_request != null)) &&
      contains(github.event.comment.body, '@claude') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR", "CONTRIBUTOR"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || format('refs/pull/{0}/head', github.event.issue.number) }}
      - uses: anthropics/claude-code-action@v1
        id: claude-review
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: "변경사항을 프론트엔드 전문가 관점으로 코드 리뷰해주세요."
          claude_args: "--max-turns 10 --allowedTools 'View' 'GlobTool' 'GrepTool'"
      - name: PR에 리뷰 결과 코멘트 작성
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const executionFile = '${{ steps.claude-review.outputs.execution_file }}';
            const fullOutput = fs.readFileSync(executionFile, 'utf8');

            const finalResultMatch = fullOutput.match(/## ✅ Final Result\n\n([\s\S]*?)(?:\*\*Cost:|\n---\n|$)/);
            const reviewResult = finalResultMatch ? finalResultMatch[1].trim() : fullOutput;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 🤖 Claude Code Review\n\n> 💡 참고: AI 리뷰는 보조 도구입니다. 최종 판단은 팀원이 해주세요.\n\n<details>\n<summary>📋 리뷰 결과 보기 (클릭)</summary>\n\n${reviewResult}\n\n</details>`
            });
